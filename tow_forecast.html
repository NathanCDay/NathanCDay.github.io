<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Opening the Charlottesville Open Data Portal with R</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="apple-touch-icon" sizes="180x180" href="www/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="www/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="www/favicon-16x16.png">
<link rel="manifest" href="www/manifest.json">
<link rel="mask-icon" href="www/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="www/favicon.ico">
<meta name="msapplication-config" content="www/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<! link rel="shortcut icon" type="image/png" href="www/favicon_dark.png">

<link rel="stylesheet" type="text/css"
          href="https://fonts.googleapis.com/css?family=Atomic+Age|Roboto|Ubuntu">
          
<style>
.navbar-brand {
    font-family:"Atomic Age";
    font-size:1.5em;
}

body {
    font-family:"Ubuntu";
}
p {
    font-size:1.1em;
}
p ~ ul {
    font-size:1.1em;
}

</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #2a211c; color: #bdae9d; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; background-color: #2a211c; color: #bdae9d; border-right: 1px solid #bdae9d; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #bdae9d; background-color: #2a211c; }
code > span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code > span.dt { text-decoration: underline; } /* DataType */
code > span.dv { color: #44aa43; } /* DecVal */
code > span.bn { color: #44aa43; } /* BaseN */
code > span.fl { color: #44aa43; } /* Float */
code > span.ch { color: #049b0a; } /* Char */
code > span.st { color: #049b0a; } /* String */
code > span.co { color: #0066ff; font-style: italic; } /* Comment */
code > span.al { color: #ffff00; } /* Alert */
code > span.fu { color: #ff9358; font-weight: bold; } /* Function */
code > span.er { color: #ffff00; font-weight: bold; } /* Error */
code > span.wa { color: #ffff00; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #049b0a; } /* SpecialChar */
code > span.vs { color: #049b0a; } /* VerbatimString */
code > span.ss { color: #049b0a; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { font-weight: bold; } /* Preprocessor */
code > span.at { } /* Attribute */
code > span.do { color: #0066ff; font-style: italic; } /* Documentation */
code > span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code > span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code > span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Nate Day</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="about.html">
    <span class="fa fa-user"></span>
     
    About
  </a>
</li>
<li>
  <a href="r4ds_exercises.html">
    <span class="fa fa-pencil"></span>
     
    R4DS
  </a>
</li>
<li>
  <a href="shiny.html">
    <span class="fa fa-flask"></span>
     
    Shiny
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bar-chart"></span>
     
    Data Docs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="tow_forecast.html">
        <span class="fa fa-key"></span>
         
        Cville Open Data
      </a>
    </li>
    <li>
      <a href="sports_senti.html">
        <span class="fa fa-futbol-o"></span>
         
        Sports Sentiment
      </a>
    </li>
    <li>
      <a href="state_park_viz.html">
        <span class="fa fa-globe"></span>
         
        State Park Popularity
      </a>
    </li>
    <li>
      <a href="Cats_with_Pipes.html">
        <span class="fa fa-puzzle-piece"></span>
         
        Piping with Purrr
      </a>
    </li>
    <li>
      <a href="dc_crime.html">
        <span class="fa fa-gavel"></span>
         
        DC Crime Report
      </a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Tech Docs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="cloudflare.html">
        <span class="fa fa-cloud"></span>
         
        HTTPS via CloudFlare
      </a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://www.linkedin.com/in/nathan-day-59b48435/">
    <span class="fa fa-linkedin-square fa-2x"></span>
     
  </a>
</li>
<li>
  <a href="https://stackoverflow.com/users/5878751/nate-day?tab=responses">
    <span class="fa fa-stack-overflow fa-2x"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/NathanCDay?tab=stars">
    <span class="fa fa-github fa-2x"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Opening the Charlottesville Open Data Portal with R</h1>
<h3 class="subtitle"><em>Time series modeling with the tidyverse</em></h3>
<h4 class="date"><em>2017/09/04</em></h4>

</div>


<div class="figure">
<img src="www/cvilletow/open_up.gif" alt="Open up already!" />
<p class="caption">Open up already!</p>
</div>
<div id="intro" class="section level1">
<h1>Intro</h1>
<p>I attended my first <a href="%22https://www.meetup.com/CharlottesvilleDataScience/events/242006576/%22">Charlottesville Data Science Meetup</a> last month, for the launch of the city’s <a href="%22http://opendata.charlottesville.org/%22">Open Data Portal</a>. The meeting unveiled the new ODP, which consolidates a bunch of Charlottesville city records in one place, including Census, assessment, development, traffic and public safety data. The meetup featured a nice introduction to the portal and <a href="http://opensourceconnections.com/">OpenSource Connections</a> provided free craft beer and free Papa Johns!!!</p>
<p>I love the OPD concept and believe that data can help drive better decisions for Charlottesville. So I used my long Labor day weekend to write up an analysis, using the ODP to do some time-series forecasting with <code>R</code>.</p>
<p>The portal had a good layout and all of the data I have touched has been well formatted (thank you so much). So let’s dive into the analysis and I apologize for the typos, but not for the bad puns.</p>
</div>
<div id="import" class="section level1">
<h1>Import</h1>
<p>I am a big user/believer of the R packages <a href="https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html"><code>magrittr</code></a> and <a href="https://www.tidyverse.org/"><code>tidyverse</code></a>, so fair warning, this analysis is pipe-heavy. I think this is a better way to code</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(forecast) <span class="co"># time-series modeling</span>
<span class="kw">library</span>(ggsci) <span class="co"># d3 color pallettes</span>
<span class="kw">library</span>(forcats) <span class="co"># fct tools</span>
<span class="kw">library</span>(lubridate) <span class="co"># date tools</span>
<span class="kw">library</span>(magrittr) <span class="co"># piping</span>
<span class="kw">library</span>(tidyverse) <span class="co"># data wranglin&#39;</span>

## ggplot set up block

<span class="co"># only theme once</span>
<span class="kw">theme_set</span>(<span class="kw">theme_minimal</span>())

<span class="co"># custom fxns to aid with axis over-plotting and assist consistant intervals</span>
brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">date</span>(<span class="st">&quot;2012-07-01&quot;</span>), <span class="kw">date</span>(<span class="st">&quot;2018-10-01&quot;</span>), <span class="st">&quot;3 months&quot;</span>)

nicely &lt;-<span class="st"> </span><span class="cf">function</span>(breaks) {
    values &lt;-<span class="st"> </span><span class="kw">as.character</span>(breaks) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">strsplit</span>(<span class="st">&quot;-&quot;</span>)
    m &lt;-<span class="st"> </span><span class="kw">map</span>(values, <span class="op">~</span><span class="st"> </span><span class="kw">as.numeric</span>(.[<span class="dv">2</span>]) <span class="op">%&gt;%</span><span class="st"> </span>month.abb[.])
    y &lt;-<span class="st"> </span><span class="kw">map</span>(values, <span class="op">~</span><span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;20&quot;</span>, <span class="st">&quot;&quot;</span>, .[<span class="dv">1</span>]))
    labels &lt;-<span class="st"> </span><span class="kw">map2</span>(m, y, <span class="op">~</span><span class="st"> </span><span class="kw">paste0</span>(., <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="kw">ifelse</span>(. <span class="op">==</span><span class="st"> &quot;Jan&quot;</span>, .y, <span class="st">&quot;&quot;</span>)))
    <span class="kw">return</span>(labels) }</code></pre></div>
<p>I decided to start my OPD journey exploring the <a href="http://opendata.charlottesville.org/datasets/crime-data">Public Safety &gt; Crime Data</a>, mainly because I’ve worked with crime data in the <a href="./dc_crime.html">past</a>. So I manually downloaded the csv from the link above and started a GitHub repository. I have yet to use the API, perhaps another day.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tib &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;~/future/CvilleTowing/Crime_Data.csv&quot;</span>)
<span class="kw">names</span>(tib) <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">tolower</span>()

<span class="co"># these don&#39;t jive well with markdown</span>
<span class="co"># head(tib)</span>
<span class="kw">str</span>(tib, <span class="dt">max.level =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    32128 obs. of  8 variables:
##  $ recordid    : int  1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 ...
##  $ offense     : chr  &quot;LARCENY-ALL OTHER LARCENY&quot; &quot;FAMILY OFFENSE-NON-VIOLENT&quot; &quot;LARCENY-THEFT OF MOTOR VEHICLE PARTS/ACCESSORIES&quot; &quot;PROPERTY-LOST&quot; ...
##  $ incidentid  : int  201206429 201206430 201206431 201206432 201206433 201206434 201206435 201206436 201206437 201206438 ...
##  $ blocknumber : int  100 2000 900 1500 1000 700 100 600 100 100 ...
##  $ streetname  : chr  &quot;14TH ST NW&quot; &quot;STADIUM RD&quot; &quot;HENRY AVE&quot; &quot;UNIVERSITY AVE&quot; ...
##  $ agency      : chr  &quot;CPD&quot; &quot;CPD&quot; &quot;CPD&quot; &quot;CPD&quot; ...
##  $ datereported: POSIXct, format: &quot;2012-10-14 00:00:00&quot; &quot;2012-10-14 00:00:00&quot; ...
##  $ hourreported: chr  &quot;1042&quot; &quot;1350&quot; &quot;1203&quot; &quot;1348&quot; ...
##  - attr(*, &quot;problems&quot;)=Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;: 1 obs. of  5 variables:
##  - attr(*, &quot;spec&quot;)=List of 2
##   ..- attr(*, &quot;class&quot;)= chr &quot;col_spec&quot;</code></pre>
<p>The function <code>read_csv</code> imputes the column types from the first 1000 rows and never coherces <code>chr</code>s as <code>fct</code>s, both are nice upgrades from the base R <code>read.csv</code>. We can see in this case it correctly guessed <code>datereported</code> as <code>POSIXct</code>, but it didn’t call <code>hourreported</code> as <code>POSIXct</code>, so it’s not magic but the <code>read_file</code> family of functions definitely save some tidying time.</p>
<p>While the data comes off the shelf nicely formatted I still wanted to make some minor adjustments before I got into exploring.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tib <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>recordid) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">unite</span>(address, blocknumber, streetname) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rename_at</span>(<span class="kw">vars</span>(<span class="kw">contains</span>(<span class="st">&quot;reported&quot;</span>)), <span class="kw">funs</span>(<span class="kw">gsub</span>(<span class="st">&quot;reported&quot;</span>, <span class="st">&quot;&quot;</span>, .))) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">hour =</span> <span class="kw">parse_time</span>(hour, <span class="dt">format =</span> <span class="st">&quot;%H%M&quot;</span>),
           <span class="dt">date =</span> <span class="kw">as.Date</span>(date),
           <span class="dt">year =</span> <span class="kw">year</span>(date),
           <span class="dt">month =</span> <span class="kw">month</span>(date))</code></pre></div>
</div>
<div id="explore" class="section level1">
<h1>Explore</h1>
<p>Now that our data has been shaped up into something tidy, let’s start looking at the data visually and see juse what we have here.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(tib, <span class="kw">aes</span>(date)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_freqpoly</span>(<span class="dt">bins =</span> <span class="dv">60</span>) <span class="op">+</span><span class="st"> </span><span class="co"># 60 months in 5 years</span>
<span class="st">    </span><span class="kw">scale_x_date</span>(<span class="dt">breaks =</span> brks, <span class="dt">date_minor_breaks =</span> <span class="st">&quot;1 month&quot;</span>,
                 <span class="dt">labels =</span> nicely, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Charlottesville police reports&quot;</span>,
         <span class="dt">y =</span> <span class="st">&quot;# reports&quot;</span>,
         <span class="dt">x =</span> <span class="ot">NULL</span>,
         <span class="dt">caption =</span> <span class="st">&quot;Data[2012-08-30:2017-08-27] &quot;</span>)</code></pre></div>
<p><img src="tow_forecast_files/figure-html/range-1.png" width="672" /></p>
<p>Looks like we have five years of continuous police reporting data going back to September 2012, not too shabby for a single csv. First glance tells us the total number of cases reported has been steady, maybe even decreasing slightly each year, which is good news for any community. It also looks like there is a consistent spike in the number of police reports each year around September and October, I wonder if we can figure out hoo/what is responsible for that fall spike in crime reports?</p>
<div id="hoo-dunnit" class="section level2">
<h2>Hoo dunnit?</h2>
<p>I don’t work with date or time data very often but when I do I always use the <a href="https://cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html"><code>lubridate</code></a> package. It maintains the tidy syntax and allows for easy manipulation (adding, subtracting, building sequence) of date and time period objects. Let’s use it here to build an series of annually reoccurring date ranges from mid-August to the end of October to feed in to <code>geom_rect()</code> highlight our window of interest.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">students_back &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">date =</span> <span class="kw">seq</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2012-09-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2017-9-01&quot;</span>), <span class="dt">length.out =</span> <span class="dv">6</span>),
                        <span class="dt">date_min =</span> date <span class="op">-</span><span class="st"> </span><span class="kw">ddays</span>(<span class="dv">16</span>), <span class="co"># ~ Aug16</span>
                        <span class="dt">date_max =</span> date <span class="op">%m+%</span><span class="st"> </span><span class="kw">months</span>(<span class="dv">2</span>) ) <span class="co"># add to month</span>

<span class="kw">ggplot</span>(tib, <span class="kw">aes</span>(date)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_rect</span>(<span class="dt">data =</span> students_back, <span class="kw">aes</span>(<span class="dt">xmin =</span> date_min, <span class="dt">xmax =</span> date_max),
              <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> <span class="ot">Inf</span>, <span class="dt">fill =</span> <span class="st">&quot;#f64617&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_freqpoly</span>(<span class="dt">bins =</span> <span class="dv">60</span>, <span class="dt">color =</span> <span class="st">&quot;#0c2345&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="co"># 60 months in 5 years</span>
<span class="st">    </span><span class="kw">scale_x_date</span>(<span class="dt">breaks =</span> brks, <span class="dt">date_minor_breaks =</span> <span class="st">&quot;1 month&quot;</span>,
                 <span class="dt">labels =</span> nicely, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),
                 <span class="dt">limits =</span> <span class="kw">c</span>(<span class="kw">date</span>(<span class="st">&quot;2012-08-16&quot;</span>), <span class="kw">date</span>(<span class="st">&quot;2017-07-31&quot;</span>))) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Charlottesville police reports&quot;</span>,
         <span class="dt">subtitle =</span> <span class="st">&quot;Rectangles highlight Aug 16th - Oct 31st&quot;</span>,
         <span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>,
         <span class="dt">caption =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="kw">italic</span>(<span class="st">&quot;Hoo&quot;</span>), <span class="st">&quot;&#39;s causing that uptick?&quot;</span>, <span class="st">&quot; Data[2012-08-16:2017-07-31]&quot;</span>)))</code></pre></div>
<p><img src="tow_forecast_files/figure-html/students-1.png" width="672" /></p>
<p>We all know correlation does not equal causation. But I would wager that this pattern is real and common for any community with a college (or transient population). Especially for Charlottesville, where the population swells by roughly 25% percent when the undergrads are in town, you would expect bump in all civic activity, including crime.</p>
<p>While this annual pattern is interesting, looking at the total counts doesn’t really tell us anything specific. Perhaps we can pull apart the total values and find some specific trends within single offense tags.</p>
</div>
<div id="offense-frequency" class="section level2">
<h2>Offense frequency</h2>
<p>This data is tagged quite well, of course there are a few inconsistent spellings but I can live with that for 32K rows. Let’s dive into the tags now, using the factor focused <a href="http://forcats.tidyverse.org/"><code>library(forcats)</code></a> to help us arrange the offenses based on frequency. PS It really helps plot preparation :)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># there is a single incident (# 201404995) that is NA for offense</span>
tib <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(offense))

forcats<span class="op">::</span><span class="kw">fct_inorder</span>(tib<span class="op">$</span>offense) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">levels</span>() <span class="op">%&gt;%</span><span class="st"> </span>.[<span class="dv">1</span><span class="op">:</span><span class="dv">25</span>]</code></pre></div>
<pre><code>##  [1] &quot;LARCENY-ALL OTHER LARCENY&quot;                        
##  [2] &quot;FAMILY OFFENSE-NON-VIOLENT&quot;                       
##  [3] &quot;LARCENY-THEFT OF MOTOR VEHICLE PARTS/ACCESSORIES&quot; 
##  [4] &quot;PROPERTY-LOST&quot;                                    
##  [5] &quot;VANDALISM/DAMAGE/DESTRUCTION OF PROPERTY&quot;         
##  [6] &quot;ASSAULT-AGGRAVATED&quot;                               
##  [7] &quot;PROPERTY-FOUND/RECOVERED&quot;                         
##  [8] &quot;SUSPICIOUS CIRCUMSTANCES-SITUATION/PERSON/VEHICLE&quot;
##  [9] &quot;PHONE CALLS-THREATENING OR OBSCENE&quot;               
## [10] &quot;ASSAULT-SIMPLE&quot;                                   
## [11] &quot;MOTOR VEHICLE THEFT/STOLEN AUTO&quot;                  
## [12] &quot;TRAFFIC-HIT AND RUN&quot;                              
## [13] &quot;BURGLARY/BREAKING AND ENTERING&quot;                   
## [14] &quot;VIOLATE PROTECTIVE ORDER&quot;                         
## [15] &quot;TRESPASS ON REAL PROPERTY&quot;                        
## [16] &quot;LARCENY-THEFT FROM MOTOR VEHICLE&quot;                 
## [17] &quot;LARCENY-THEFT FROM BUILDING&quot;                      
## [18] &quot;DRUG/NARCOTIC VIOLATION&quot;                          
## [19] &quot;COMMUNITY RELATIONS INITIATIVE (CRI)&quot;             
## [20] &quot;TOWED VEHICLE&quot;                                    
## [21] &quot;PERJURY&quot;                                          
## [22] &quot;LARCENY-SHOPLIFTING&quot;                              
## [23] &quot;FRAUD-FALSE PRETENSES/SWINDLE/CONFIDENCE GAME&quot;    
## [24] &quot;ASSAULT-INTIMIDATION&quot;                             
## [25] &quot;MISC CRIMINAL/STALKING&quot;</code></pre>
<p>The list of the top 25 most frequent offense tags looks pretty consistent, all uppercase, with the “-” being consistently used to show sub-groups and the “/” being used to show aliases. To get a macro view of the type of crimes being committed I am going to collapse the subgroups moving forward. However I want to point out, this detailed naming system give us the ability to easily investigate subgroup differences, it’s a really nice surprise that it is formatted so well!</p>
<p>Probably my favorite functions out of <code>library(forcats)</code> are <code>fct_infreq()</code> and <code>fct_inorder()</code> The first does the equivalent of <code>table() %&gt;% sort(descreasing = T) %&gt;% unique()</code> to define the the levels of a factor, with the most frequent assigned lowest levels by default. It’s counter-part <code>fct_inorder()</code> assigns levels based on current tibble order, and this can be equally useful when piped after <code>arrange()</code>. <code>arrange(mtcars, -cyl) %&gt;% mutate(cyl = fct_inorder(cyl))</code>. If you take one thing away from this write up hopefully these two are it, they are nice additions to R and big time savers for me.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tib<span class="op">$</span>offense <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;-.*&quot;</span>, <span class="st">&quot;&quot;</span>, .) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">gsub</span>(<span class="st">&quot;/.*&quot;</span>, <span class="st">&quot;&quot;</span>, .)

<span class="co"># reset levels</span>
tib<span class="op">$</span>offense <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">as.factor</span>() <span class="op">%&gt;%</span>
<span class="st">    </span>forcats<span class="op">::</span><span class="kw">fct_infreq</span>()</code></pre></div>
<p>Now we have our tags collapsed and ordered by frequency, let’s look at the distribution of reports across offenses. I’m using a little <code>as.numeric(any_factor)</code> hack here to help avoid too much axis text. Also since most time-series data follows an exponential distribution, I went ahead and simulated a random draw from an exponential distribution with a mean of 6. This distribution comparison serves as a visualize sanity check to make sure we’re on the right path.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># simulated data</span>
sims_tib &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">offense =</span> <span class="kw">round</span>(<span class="kw">rexp</span>(<span class="dt">n =</span> <span class="kw">nrow</span>(tib), <span class="dt">rate =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">6</span>)))
<span class="co"># rate is defined as 1 / mu for exponential distributions</span>

<span class="kw">ggplot</span>(tib, <span class="kw">aes</span>(<span class="kw">as.numeric</span>(offense), <span class="dt">fill =</span> <span class="st">&quot;real data&quot;</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">alpha =</span> .<span class="dv">5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">data =</span> sims_tib, <span class="kw">aes</span>(<span class="dt">fill =</span> <span class="st">&quot;exponential sim&quot;</span>), <span class="dt">alpha =</span> .<span class="dv">5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">&quot;Set1&quot;</span>, <span class="dt">name =</span> <span class="ot">NULL</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">10</span>,<span class="dv">50</span>,<span class="dv">10</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">50</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Top 50 tags compared to expoential distribution (mu = 6)&quot;</span>,
         <span class="dt">y =</span> <span class="st">&quot;tag count&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;tag rank by count&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(.<span class="dv">85</span>, .<span class="dv">85</span>))</code></pre></div>
<p><img src="tow_forecast_files/figure-html/distribution-1.png" width="672" /></p>
<p>The real data and the simulated data line up really well! I like doing these checks early on in an analysis, just to make sure I’m not missing any unexpected features or I’m not wasting my time on noise.</p>
<p>Now we are starting to feel pretty good about our dataset…let’s take a closer look at the top 16 tags and see if we can detect any interesting patterns that might help explain the overall spikes we were seeing in total cases in September and October.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">top16 &lt;-<span class="st"> </span><span class="kw">mutate</span>(tib, <span class="dt">offense =</span> forcats<span class="op">::</span><span class="kw">fct_infreq</span>(offense)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(offense <span class="op">%in%</span><span class="st"> </span><span class="kw">levels</span>(offense)[<span class="dv">1</span><span class="op">:</span><span class="dv">16</span>]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">droplevels</span>()

<span class="co"># decode to shorter names for plotting</span>
decode &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Larceny&quot;</span>, <span class="st">&quot;Assault&quot;</span>, <span class="st">&quot;Towing&quot;</span>, <span class="st">&quot;Traffic&quot;</span>,
            <span class="st">&quot;Vandalism&quot;</span>, <span class="st">&quot;Property&quot;</span>, <span class="st">&quot;Drugs&quot;</span>, <span class="st">&quot;Assist Citizen&quot;</span>,
            <span class="st">&quot;Suspicious&quot;</span>, <span class="st">&quot;Fraud&quot;</span>, <span class="st">&quot;Burglary&quot;</span>, <span class="st">&quot;Animal&quot;</span>,
            <span class="st">&quot;Runaway&quot;</span>, <span class="st">&quot;DUI&quot;</span>, <span class="st">&quot;Disorderly&quot;</span>, <span class="st">&quot;Missing Person&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">set_names</span>(<span class="kw">levels</span>(top16<span class="op">$</span>offense))

<span class="co"># use forcats::fct_infreq() again</span>
top16<span class="op">$</span>offense <span class="op">%&lt;&gt;%</span><span class="st"> </span>decode[.] <span class="op">%&gt;%</span>
<span class="st">    </span>forcats<span class="op">::</span><span class="kw">fct_infreq</span>()

<span class="kw">ggplot</span>(top16, <span class="kw">aes</span>(date, <span class="dt">color =</span> offense)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_rect</span>(<span class="dt">data =</span> students_back, <span class="kw">aes</span>(<span class="dt">xmin =</span> date_min, <span class="dt">xmax =</span> date_max),
              <span class="dt">ymin =</span> <span class="op">-</span><span class="dv">0</span>, <span class="dt">ymax =</span> <span class="ot">Inf</span>, <span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">fill =</span> <span class="st">&quot;grey&quot;</span>, <span class="dt">alpha =</span> .<span class="dv">5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_freqpoly</span>(<span class="dt">alpha =</span> .<span class="dv">75</span>, <span class="dt">bins =</span> <span class="dv">60</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_date</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="kw">date</span>(<span class="st">&quot;2013-01-01&quot;</span>), <span class="kw">date</span>(<span class="st">&quot;2017-01-01&quot;</span>), <span class="dt">length.out =</span> <span class="dv">5</span>),
                 <span class="dt">date_labels =</span> <span class="st">&quot;&#39;%y&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="kw">date</span>(<span class="st">&quot;2012-08-15&quot;</span>), <span class="kw">date</span>(<span class="st">&quot;2017-08-16&quot;</span>))) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_color_d3</span>(<span class="dt">palette =</span> <span class="st">&quot;category20&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>offense, <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Top 16 most reported offenses (collapsed)&quot;</span>,
         <span class="dt">caption =</span> <span class="st">&quot;Data[2012-08-15:2017-08-01]&quot;</span>,
         <span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">x =</span> <span class="ot">NULL</span>)</code></pre></div>
<p><img src="tow_forecast_files/figure-html/top16-1.png" width="672" /></p>
<p>It looks like “Assault”, “Towing”, “Vandalism” and “Disorderly” all have yearly spikes during our August to November, interval of interest . “Towing” is the only one of those that looks like it has been increasing steadily over the last five years. I will be focusing on “Towing” only in the time-series modeling next, but remember that “Assault”, had sub-categories that we collapsed earlier, so that might be an interesting area to look into further if one where so inclined.</p>
</div>
<div id="forcast-calls-for-tow" class="section level2">
<h2>Forcast calls for tow</h2>
<p>To get start with “Towing”, first lets quantify that year over year increase, we saw in the spark lines and get a better handle on the seasonal distribution with a nice stacked histogram.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tow &lt;-<span class="st"> </span><span class="kw">filter</span>(top16, offense <span class="op">==</span><span class="st"> &quot;Towing&quot;</span>)

<span class="co"># drop 2012 and 2017 bc partial years</span>
tow <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2012&quot;</span>, <span class="st">&quot;2017&quot;</span>)))

<span class="kw">ggplot</span>(tow, <span class="kw">aes</span>(<span class="kw">as.numeric</span>(month), <span class="dt">fill =</span> <span class="kw">as.factor</span>(year))) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_rect</span>(<span class="dt">xmin =</span> <span class="dv">8</span>, <span class="dt">xmax =</span> <span class="fl">10.5</span>, <span class="dt">ymax =</span> <span class="ot">Inf</span>, <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">fill =</span> <span class="st">&quot;grey&quot;</span>, <span class="dt">alpha =</span> .<span class="dv">5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_histogram</span>(<span class="dt">bins =</span> <span class="dv">12</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">12</span>, <span class="dt">labels =</span> month.abb, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span>
<span class="st">    </span>viridis<span class="op">::</span><span class="kw">scale_fill_viridis</span>(<span class="dt">name =</span> <span class="ot">NULL</span>, <span class="dt">discrete =</span> <span class="ot">TRUE</span>, <span class="dt">direction =</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Monthly tow-tals&quot;</span>,
         <span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>,
         <span class="dt">caption =</span> <span class="st">&quot;Data[2013-01-01:2016-12-31]&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(.<span class="dv">95</span>, .<span class="dv">9</span>))</code></pre></div>
<p><img src="tow_forecast_files/figure-html/tow-1.png" width="672" /></p>
<p>We can see that the big annual spike is peaking in Sept-Oct. There also is a small bump in March and April, which also coincides with students returning for semester. Perhaps there is something else lurking to better explain our towing report spikes? Football maybe?</p>
<p>Regardless it’s clear that this data set has repeated annual patterns. So if we want to model it, a simple <code>lm()</code> won’t do for accurately projecting future monthly towing totals.</p>
<p>This ia where the <code>library(forecast)</code> comes in to define a syntax for time series modeling. This wonderful package, built by <a href="https://github.com/robjhyndman">Rob Hyndman</a>, is on version 8.1 as of this typing and has long been the standard tool for time-series analysis with <code>R</code>. It comes loaded with a bunch of customization functions for smoothing and decomposing, but for now let’s stick to the basics to get going.</p>
<p>The first step to working with <code>forecast()</code> is to create a <code>time.series</code> object, which is just the response variable values grouped by time series period. Don’t worry they are easy to create and print very well in the console :)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># reset to all data</span>
tow &lt;-<span class="st"> </span><span class="kw">filter</span>(top16, offense <span class="op">==</span><span class="st"> &quot;Towing&quot;</span>)

month_tib &lt;-<span class="st"> </span><span class="kw">arrange</span>(tow, year, month) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(year, month) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tally</span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">slice</span>(<span class="op">-</span><span class="dv">1</span>) <span class="co"># drop Aug 2012 (only 6 cases)</span>

month_vec &lt;-<span class="st"> </span><span class="kw">select</span>(month_tib, n) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">unlist</span>()

<span class="co"># build time-series object</span>
myts &lt;-<span class="st"> </span><span class="kw">ts</span>(month_vec, <span class="dt">start =</span> <span class="kw">c</span>(<span class="dv">2012</span>, <span class="dv">9</span>), <span class="dt">frequency =</span> <span class="dv">12</span>)
myts</code></pre></div>
<pre><code>##      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
## 2012                                  54  54  60  27
## 2013  16  25  31  49  27  34  35  40  64  66  50  51
## 2014  35  33  43  38  53  39  44  49  53  61  63  29
## 2015  31  31  48  67  39  23  36  68  85  67  53  36
## 2016  71  50  70  51  49  49  45  54  82 104  53  28
## 2017  60  65  76  81  56  44  46  48</code></pre>
<p>Now that we have restructured our data for <code>forecast()</code>, we can take advantage of its really nice default model paramenters. To start with let’s peak at the underlying trends with the decomposition function <code>stl()</code>, which stands for Seasonal, Trend and Loess.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">decomp_fit &lt;-<span class="st"> </span><span class="kw">stl</span>(myts, <span class="dt">s.window=</span> <span class="st">&quot;periodic&quot;</span>)

<span class="kw">plot</span>(decomp_fit)</code></pre></div>
<p><img src="tow_forecast_files/figure-html/stl-1.png" width="672" /></p>
<p>That is a quick way to look at the model components. We can see our raw data, the seasonal model, the loess trend model, its residuals to the raw data. The model has detected the strong seasonal spike we saw in September and Octorber as well as the steady annual increase of tows reported.</p>
<p>Next let’s build a model that can combine the seasonal and trend components via <code>HoltWinters()</code>. This will allow us to project future towing report rates using all of the seasonal pattern information we have in our model to help us make more accurate predictions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hw_fit &lt;-<span class="st"> </span><span class="kw">HoltWinters</span>(myts)
<span class="co"># plot(hw_fit)</span>

<span class="co"># make predictions </span>
month_preds &lt;-<span class="st"> </span><span class="kw">forecast</span>(hw_fit, <span class="dv">15</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># 15 periods ahead; returns Sep17 : Oct18</span>
<span class="st">    </span>as.tibble <span class="op">%&gt;%</span>
<span class="st">    </span>.[[<span class="dv">1</span>]]</code></pre></div>
<p>Using for the abilities of <code>forecast()</code> it is easy to use our model for future projections. The only thing we have to do now is tidy up those projections so we can plot them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># build a tidy tib for plotting</span>
next_tib &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">date =</span> <span class="kw">seq</span>(<span class="kw">date</span>(<span class="st">&quot;2017-09-01&quot;</span>), <span class="kw">date</span>(<span class="st">&quot;2018-11-01&quot;</span>), <span class="st">&quot;1 month&quot;</span>),
                    <span class="dt">y =</span> month_preds)

<span class="co"># format month_tib to match next_tib</span>
month_tib <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">date =</span> <span class="kw">date</span>(<span class="kw">paste</span>(year, month, <span class="st">&quot;01&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>))) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rename</span>(<span class="dt">y =</span> n)

<span class="co"># bind on AUG17 info for smoothness</span>
aug17 &lt;-<span class="st"> </span>month_tib[<span class="kw">nrow</span>(month_tib),]
next_tib <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">bind_rows</span>(aug17, .)</code></pre></div>
<p>Now we have built a data source ready to plug into <code>ggplot()</code> to show our model predictions for the next year.</p>
<p>Just to really drive home the difference of between the seasonal and loess trend component of our model, let’s build out the loess model for the identical interval, for co-plotting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trend_fit &lt;-<span class="st"> </span><span class="kw">HoltWinters</span>(decomp_fit<span class="op">$</span>time.series[,<span class="dv">2</span>])
trend_preds &lt;-<span class="st"> </span><span class="kw">forecast</span>(trend_fit, <span class="dv">15</span>) <span class="op">%&gt;%</span>
<span class="st">    </span>as.tibble <span class="op">%&gt;%</span>
<span class="st">    </span>.[[<span class="dv">1</span>]]

<span class="co"># bind in old data in model</span>
trend_past &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(decomp_fit<span class="op">$</span>time.series[,<span class="dv">2</span>])
trend_tib &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">date =</span> <span class="kw">seq</span>(<span class="kw">date</span>(<span class="st">&quot;2012-09-01&quot;</span>), <span class="kw">date</span>(<span class="st">&quot;2018-11-01&quot;</span>), <span class="dt">by =</span> <span class="st">&quot;1 month&quot;</span>),
                     <span class="dt">y =</span> <span class="kw">c</span>(trend_past, trend_preds))</code></pre></div>
<p>Now all we have to do is layer them together.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># expand students_back for future</span>
students_back2 &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">date =</span> <span class="kw">seq</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2012-09-01&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2018-09-01&quot;</span>), <span class="st">&quot;1 year&quot;</span>),
                        <span class="dt">date_min =</span> date <span class="op">-</span><span class="st"> </span><span class="kw">ddays</span>(<span class="dv">16</span>), <span class="co"># ~ Aug16</span>
                        <span class="dt">date_max =</span> date <span class="op">%m+%</span><span class="st"> </span><span class="kw">months</span>(<span class="dv">2</span>) )

<span class="co"># format next_tib</span>
next_tib<span class="op">$</span>year &lt;-<span class="st"> </span><span class="kw">year</span>(next_tib<span class="op">$</span>date)

<span class="co"># projections plot</span>
<span class="kw">ggplot</span>(month_tib, <span class="kw">aes</span>(date, y, <span class="dt">color =</span> y)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_rect</span>(<span class="dt">data =</span> students_back2, <span class="kw">aes</span>(<span class="dt">xmin =</span> date_min, <span class="dt">xmax =</span> date_max, <span class="dt">y =</span> <span class="ot">NULL</span>),
              <span class="dt">ymin =</span> <span class="op">-</span><span class="dv">0</span>, <span class="dt">ymax =</span> <span class="ot">Inf</span>, <span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">fill =</span> <span class="st">&quot;grey&quot;</span>, <span class="dt">alpha =</span> .<span class="dv">5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_path</span>(<span class="dt">data =</span> trend_tib, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> y, <span class="dt">color =</span> <span class="ot">NULL</span>), <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_path</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_path</span>(<span class="dt">data =</span> next_tib, <span class="kw">aes</span>(<span class="dt">y =</span> y), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> .<span class="dv">5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">label =</span> <span class="st">&quot;&lt;&lt;&lt; Historical | Projected &gt;&gt;&gt;&quot;</span>, <span class="dt">x =</span> <span class="kw">date</span>(<span class="st">&quot;2017-08-01&quot;</span>), <span class="dt">y =</span> <span class="dv">110</span>, <span class="dt">size =</span> <span class="dv">3</span>) <span class="op">+</span>
<span class="st">    </span>viridis<span class="op">::</span><span class="kw">scale_color_viridis</span>(<span class="dt">name =</span> <span class="ot">NULL</span>, <span class="dt">direction =</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_date</span>(<span class="dt">breaks =</span> brks, <span class="dt">date_minor_breaks =</span> <span class="st">&quot;1 month&quot;</span>,
                 <span class="dt">labels =</span> nicely, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),
                 <span class="dt">limits =</span> <span class="kw">c</span>(<span class="kw">date</span>(<span class="st">&quot;2012-08-16&quot;</span>), <span class="kw">date</span>(<span class="st">&quot;2018-11-01&quot;</span>))) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Forecasted monthly tow-tals&quot;</span>,
         <span class="dt">subtitle =</span> <span class="st">&quot;Mean trend as dashed line&quot;</span>,
         <span class="dt">y =</span> <span class="ot">NULL</span>,
         <span class="dt">x =</span> <span class="ot">NULL</span>,
         <span class="dt">caption =</span> <span class="st">&quot;Data[2012-08-16:2017-08-31]; Projections[2017-09-01:2018-10-31]&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</code></pre></div>
<p><img src="tow_forecast_files/figure-html/fin_plot-1.png" width="672" /></p>
<p>We see the loess (dashed) trend moving back down towards the historical average in our projection, while the our total seasonal plus trend model is still climbing upward.</p>
<p>I hope this outline is a useful template for jumping into the ODP Crime Data with R. I know there a lot of trends in the Crime Data set that deserve more exploration, so time to get busy. Hopefully this portal can be used to have fun and build a more informed and engaged community. See you at the next Meetup!</p>
</div>
</div>

<hr>
<p>
    Built with <a href = "http://rmarkdown.rstudio.com/rmarkdown_websites.html">Rmd</a>.
    Hosted on <a href = "https://pages.github.com/">Github</a>.
        Maintained by <a href = "mailto:nathancday@gmail.com">me</a>.
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />
</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
